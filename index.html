<!doctype html>
<html lang="en">
<meta charset='utf-8'>

<link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css">

<script src='https://code.jquery.com/jquery-2.1.4.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js'></script>
<script src="https://cdn.firebase.com/js/client/2.2.9/firebase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/js/bootstrap-select.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>



<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  padding:0;
  margin:0;
  vertical-align:center;
  text-align:center;
}
h1 {
  margin:0;
  line-height: 150px;
  font-family: 'Roboto Slab';
}
</style>

<div style="height:150px; background-color:White; color:Navy">
  <h1>Water Wizard</h1>
</div>

<div style="height:230px; padding:40px;background-color:Navy; color:white">
  <p>Upcoming watering time: <b>7:00 pm (in 3 hours)</b></p>
  <a href>Skip this time</a><br><br><br>
  <button class="btn btn-default btn-lg" onclick="ledHelper(this)">Water Now!</button>
</div>

<div style="height:200px; margin: 20px; ">

  <div style="width:50%; height: 200px; float:left">
    <div class="panel panel-default" style="height:100%; margin:10px 15px 10px 10px;">
      <div class="panel-body">

      <p><font size="5"> Temperature Sensor: </font>
      <br>
      </p>
      <p><font size="9">
      <span id="temp"></span></font></p>
      </br>

      </div>
    </div>
  </div>

  <div style="width:50%; height: 200px; float:left">
    <div class="panel panel-default" style="height:100%; margin:10px 10px 10px 15px;">
      <div class="panel-body">
      <p><font size="5">  Humidity: </font>
          <br>
          </p>
          <p><font size="9">
        <span id="humidity"></span></span></font></p>
      </br>
      </div>
    </div>
  </div>

</div>
<div style="height: 260px;position:relative;margin:30px;" class="panel panel-default">
  <div style="z-index:11;position:absolute;top:15px;left:50%;transform:translateX(-50%) translateY(-50%);"><b>Weather for University of Michigan</b></div>
<iframe id="forecast_embed" type="text/html" frameborder="0" height="245" width="100%" src="http://forecast.io/embed/#lat=42.2828&lon=-83.7347&name=University of Michigan" style="padding-left:0px;width:80%"> </iframe>
  <div style="position:absolute; top:0;left:0; background-color:white; width:100%; height:50px;z-index: 10;">
  </div>
</div>
<div style="background-color:#99CCFF; padding-bottom: 30px">
  <h1>Watering Times</h1>
  <b>Profile</b> &nbsp;
  <select class="selectpicker">
    <optgroup>
      <option>Water the plants</option>
      <option>Give water to the dog</option>
    </optgroup>
    <optgroup>
      <option>New Profile...</option>
    </optgroup>
  </select>
  <br><br>
  <a href>Edit Name</a> |
  <a href>Delete</a>
  <br><br>
  <div style="text-align: left;border-radius: 20px;background-color:white; width: 70%; margin: 0 auto; padding: 10px 0;">
<div style="padding-left: 40px;">
      <h4><b>New Repeated Event</b></h4><br>

      <b>Time: </b>

      
        <div id="times">
          <div class="form-group one_time" style="width: 150px; display: inline-block; margin-bottom: 0px">
              <div class='input-group date datetimepicker2'>
                  <input type='text' class="form-control" />
                  <span class="input-group-addon">
                      <span class="glyphicon glyphicon-time"></span>

                  </span>


              </div>


          </div>
               <br> <button class="btn btn-default" id="addTime">+</button>

        </div><!-- times -->




        <br><br>
        <b>Flow Duration:</b><br>

        <input type="text" class="form-control" style="width:50px; display:inline;" value="2">
          <select class="selectpicker">
            <option value="volvo">seconds</option>
            <option value="saab">minutes</option>
            <option value="saab">hours</option>
          </select>

          <br><br>
      <b>Days of the Week: </b> <br>

      <input type="checkbox" checked> S 
      <input type="checkbox" checked> M 
      <input type="checkbox" checked> T 
      <input type="checkbox" checked> W 
      <input type="checkbox" checked> Th 
      <input type="checkbox" checked> F 
      <input type="checkbox" checked> Sa 
      <br><br>

      <b>Run if it will rain in the next 2 days? </b> <input type="checkbox" checked><br><br>
      <b>If the weather will get really hot in the next day, still water? <input type="checkbox" checked>
      <br><br>

      <h4><b>Optional</b></h4>
      
      <b>Start Date/Time</b> <br>

      <div class="form-group" style="width: 300px;">
              <div class='input-group date' id='datetimepicker3'>
                  <input type='text' class="form-control" />
                  <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                  </span>
              </div>

      <b>Stop Date/Time</b> <br>

<div class="form-group" style="width: 300px;">
              <div class='input-group date' id='datetimepicker3'>
                  <input type='text' class="form-control" />
                  <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                  </span>
                        

              </div>
              <br><br>
              <button class="btn btn-primary">Save</button>&nbsp;
              <button class="btn btn-default">Clear</button>
      </div>
      </div>
    </div>
  </div>
</div>

<br>

<form action="https://api.particle.io/v1/devices/54ff6a066672524819361267/led?access_token=22de5c62f0253e4cabad74d98664301dabaa4859" method="POST">
  <h3>Manual Control</h3>
    <input type="radio" name="args" value="on">Open
    &nbsp;    <input type="radio" name="args" value="off">Close &nbsp;
    <br><br>
    <input type="submit" class="btn btn-default" value="Go!"><br><br>
  </form>

<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<script>
  $(function() {
    $('.selectpicker').selectpicker();
    $('.datetimepicker2').datetimepicker({
           format: 'LT'
    });

  });
  var myFirebaseRef = new Firebase("https://mhacks6.firebaseio.com/");
  var tempRef = myFirebaseRef.child("curr_temp");
  var humidityRef = myFirebaseRef.child("curr_humidity");
  var tempHistRef = myFirebaseRef.child("tempHist");
  var humidityHistRef = myFirebaseRef.child("humidityHist");
  var deviceID = "54ff6a066672524819361267";
  var accessToken = "22de5c62f0253e4cabad74d98664301dabaa4859";
  var varName1 = "temperature";
  var varName2 = "humidity";
  var myTemps = [];
  var myHumidities = [];
  var graphData = [];
  var graphData2 = [];
  
  updateSensorData();

  $('#addTime').click(addTime);
  function addTime() {
      $('.one_time').last().append('<div class="form-group one_time" style="margin-top: 3px;width: 150px;"><div class="input-group date datetimepicker2"><input type="text" class="form-control" /><span class="input-group-addon"><span class="glyphicon glyphicon-time"></span></span></div>');
  }
  function updateSensorData() {
    document.getElementById("temp").innerHTML = "Waiting for data...";
    document.getElementById("humidity").innerHTML = "Waiting for data...";


    window.setInterval(function() {

      requestURL = "https://api.particle.io/v1/devices/" + deviceID + "/" + varName1 + "/?access_token=" + accessToken;
      $.getJSON(requestURL, function(json) {
               document.getElementById("temp").innerHTML = parseFloat(json.result).toFixed(1) + "&deg; F";
               tempRef.set(json.result);
               tempHistRef.push(json.result);
               myTemps = [];
               });
      requestURL2 = "https://api.particle.io/v1/devices/" + deviceID + "/" + varName2 + "/?access_token=" + accessToken;
      $.getJSON(requestURL2, function(json) {
               document.getElementById("humidity").innerHTML = parseFloat(json.result).toFixed(1) + "%";
               humidityRef.set(json.result);
               humidityHistRef.push(json.result);
               myHumidities = [];
               document.getElementById("tstamp").innerHTML = json.coreInfo.last_heard;
               });

      var chart=$("#container").highcharts();

      humidityHistRef.orderByKey().limitToLast(10).on("child_added", function(snapshot) {
        humidityHistRef.orderByKey().limitToLast(10).on("value", function(snapshot2) {
          myHumidities = [];
          snapshot2.forEach(function(data) {
            myHumidities.push(data.val());
          });
        });
      });
      graphData2 = myHumidities;
      console.log("graphData2: " + graphData2.toString());
      for(i = 0;i<10;i++)
      {
        chart.series[1].data[i].update(graphData2[i]); 
      }

      tempHistRef.orderByKey().limitToLast(10).on("child_added", function(snapshot) {
        tempHistRef.orderByKey().limitToLast(10).on("value", function(snapshot2) {
          myTemps = [];
          snapshot2.forEach(function(data) {
            myTemps.push(data.val());
          });
        });
      });
      graphData = myTemps;
      console.log("graphData: " + graphData.toString());
      for(i = 0;i<10;i++)
      {
        chart.series[0].data[i].update(graphData[i]);
      }
    }, 6000);
  }

  function ledHelper(obj) {
    var duration = 1500;
    sparkLedOnFor(duration);
  }

  function sparkLedOnFor(time) {
    var requestURL = "https://api.spark.io/v1/devices/" +deviceID + "/" + "ledOnFor" + "/";
    $.post( requestURL, { params: time, access_token: accessToken });
  }



  $(function () {
      $('#container').highcharts({
          title: {
              text: 'Temperature & Humidity History',
              x: -20 //center
          },
          subtitle: {
              text: 'Over the past minute',
              x: -20
          },
          xAxis: {
            title: {
                text: 'Seconds (s)'
            },
              categories: ['6', '12', '18', '24', '30', '36',
                  '42', '48', '54', '60']
          },
          yAxis: {
              title: {
                  text: 'Temperature (°F)'
              },
              plotLines: [{
                  value: 0,
                  width: 1,
                  color: '#808080'
              }]
          },
          tooltip: {
              valueSuffix: '°C'
          },
          legend: {
              layout: 'vertical',
              align: 'right',
              verticalAlign: 'middle',
              borderWidth: 0
          },
          series: [{
             name: 'Temperature',
             data: [1,2,3,4,5,6,7,8,9,10]
         }, {
             name: 'Humidity',
             data: [1,2,3,4,5,6,5,4,3,2]
         }]
     });
 });

</script>

</html>
